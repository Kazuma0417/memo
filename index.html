<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBメモ帳 (Firebase版)</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 50px; }
        #auth-container, #memo-container { background-color: #f0f0f0; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #memo-container { width: 80%; max-width: 600px; display: none; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        button:hover { background-color: #0056b3; }
        #logout-button { background-color: #dc3545; margin-left: auto; }
        #logout-button:hover { background-color: #c82333; }
        .message { color: red; margin-top: 10px; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    </head>
<body>

    <div id="auth-container">
        <h2>ログイン / 新規登録</h2>
        <input type="email" id="email" placeholder="メールアドレス" required><br><br>
        <input type="password" id="password" placeholder="パスワード" required><br><br>
        <button onclick="signup()">新規登録</button>
        <button onclick="login()">ログイン</button>
        <p id="auth-message" class="message"></p>
    </div>

    <div id="memo-container">
        <div class="header-controls">
            <h2 id="current-user-email"></h2>
            <button id="logout-button" onclick="logout()">ログアウト</button>
        </div>
        <textarea id="memo-content" placeholder="ここにメモを書いてください..."></textarea>
        <button onclick="saveMemo()">メモを保存</button>
    </div>

    <script>
        // --- ここに、ステップ3でFirebaseコンソールからコピーした設定を貼り付けます ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ----------------------------------------------------------------------

        // Firebaseの初期化
        firebase.initializeApp(firebaseConfig);

        // 必要なFirebaseサービスのインスタンスを取得
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM要素の取得
        const authContainer = document.getElementById('auth-container');
        const memoContainer = document.getElementById('memo-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authMessage = document.getElementById('auth-message');
        const memoContent = document.getElementById('memo-content');
        const currentUserEmail = document.getElementById('current-user-email');

        let currentUser = null; // 現在ログイン中のユーザー情報を保持

        // 認証状態の監視
        auth.onAuthStateChanged(user => {
            if (user) {
                // ユーザーがログインしている場合
                currentUser = user;
                currentUserEmail.textContent = `ユーザー: ${user.email}`;
                showMemoPage();
                loadMemo(user.uid); // ユーザーのUIDを使ってメモをロード
            } else {
                // ユーザーがログアウトしている場合
                currentUser = null;
                showAuthPage();
                memoContent.value = ''; // メモをクリア
            }
        });

        // --- 認証関連の関数 ---

        async function signup() {
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                authMessage.textContent = '新規登録成功！自動でログインしました。';
            } catch (error) {
                authMessage.textContent = `新規登録エラー: ${error.message}`;
                console.error("サインアップエラー:", error);
            }
        }

        async function login() {
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                authMessage.textContent = 'ログイン成功！';
            } catch (error) {
                authMessage.textContent = `ログインエラー: ${error.message}`;
                console.error("ログインエラー:", error);
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                authMessage.textContent = 'ログアウトしました。';
            } catch (error) {
                authMessage.textContent = `ログアウトエラー: ${error.message}`;
                console.error("ログアウトエラー:", error);
            }
        }

        // --- メモ保存・読み込み関数 (Firestoreを使用) ---

        async function saveMemo() {
            if (!currentUser) {
                authMessage.textContent = 'ログインしてください。';
                return;
            }
            const memoText = memoContent.value;
            // ユーザーのUIDをドキュメントIDとして使用し、ユーザーごとのメモを保存
            try {
                await db.collection('memos').doc(currentUser.uid).set({
                    content: memoText,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() // サーバーのタイムスタンプ
                });
                alert('メモを保存しました！');
            } catch (error) {
                alert('メモの保存に失敗しました。');
                console.error("メモ保存エラー:", error);
            }
        }

        async function loadMemo(uid) {
            try {
                const doc = await db.collection('memos').doc(uid).get();
                if (doc.exists) {
                    memoContent.value = doc.data().content || '';
                } else {
                    memoContent.value = ''; // メモがない場合はクリア
                }
            } catch (error) {
                console.error("メモ読み込みエラー:", error);
                memoContent.value = 'メモの読み込みに失敗しました。';
            }
        }

        // --- UI表示切り替え関数 ---

        function showMemoPage() {
            authContainer.style.display = 'none';
            memoContainer.style.display = 'block';
        }

        function showAuthPage() {
            authContainer.style.display = 'block';
            memoContainer.style.display = 'none';
            emailInput.value = ''; // 入力フィールドをクリア
            passwordInput.value = ''; // 入力フィールドをクリア
        }
    </script>
</body>
</html>
